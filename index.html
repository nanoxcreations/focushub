<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FocusHub — Productivity Center</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Google Fonts: DM Sans -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet" />

<style>
/* =============================================
   CSS RESET & ROOT VARIABLES
   ============================================= */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep:       #080a10;
  --bg-base:       #0d0f18;
  --bg-card:       rgba(255,255,255,0.04);
  --bg-card-hover: rgba(255,255,255,0.07);
  --border:        rgba(255,255,255,0.08);
  --border-strong: rgba(255,255,255,0.14);

  --accent:        #6c63ff;
  --accent-glow:   rgba(108,99,255,0.25);
  --accent2:       #00d4aa;
  --accent2-glow:  rgba(0,212,170,0.2);
  --danger:        #ff4d6d;
  --warning:       #ffb830;
  --success:       #34d399;

  --text-primary:  #f0f0f5;
  --text-secondary:#8b8fa8;
  --text-muted:    #565870;

  --sidebar-w:     245px;
  --topbar-h:      64px;
  --radius:        14px;
  --radius-sm:     8px;
  --transition:    0.22s ease;
  --font: 'DM Sans', system-ui, sans-serif;
}

html { font-family: var(--font); font-size: 15px; }
body { background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; line-height: 1.6; }

/* =============================================
   SCROLLBAR
   ============================================= */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 10px; }

/* =============================================
   AUTH SCREEN
   ============================================= */
#auth-screen {
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; background: var(--bg-deep);
  position: relative; overflow: hidden;
}
#auth-screen::before {
  content:''; position:absolute; width:600px; height:600px;
  background: radial-gradient(circle, rgba(108,99,255,0.15) 0%, transparent 70%);
  top:-100px; left:-100px; pointer-events:none;
}
#auth-screen::after {
  content:''; position:absolute; width:500px; height:500px;
  background: radial-gradient(circle, rgba(0,212,170,0.1) 0%, transparent 70%);
  bottom:-80px; right:-80px; pointer-events:none;
}

.auth-box { width:100%; max-width:420px; padding:0 1.5rem; position:relative; z-index:2; animation: fadeUp 0.5s ease both; }
.auth-logo { text-align:center; margin-bottom:2rem; }
.auth-logo .logo-icon {
  width:54px; height:54px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius:14px; display:inline-flex; align-items:center; justify-content:center;
  font-size:1.5rem; margin-bottom:1rem; box-shadow: 0 8px 32px var(--accent-glow);
}
.auth-logo h1 { font-size:1.6rem; font-weight:700; letter-spacing:-0.02em; }
.auth-logo p  { color:var(--text-secondary); font-size:0.875rem; margin-top:0.25rem; }
.auth-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:2rem; backdrop-filter:blur(20px); box-shadow:0 20px 60px rgba(0,0,0,0.4); }
.auth-tabs { display:flex; gap:0.5rem; margin-bottom:1.75rem; }
.auth-tab {
  flex:1; padding:0.6rem; background:transparent;
  border:1px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text-secondary); font-size:0.875rem; font-weight:500;
  cursor:pointer; font-family:var(--font); transition:var(--transition);
}
.auth-tab.active { background:var(--accent); border-color:var(--accent); color:#fff; box-shadow:0 4px 16px var(--accent-glow); }

.form-group { margin-bottom:1rem; }
.form-group label { display:block; font-size:0.8125rem; font-weight:500; color:var(--text-secondary); margin-bottom:0.4rem; transition:color 0.2s ease; }
.form-group:focus-within label { color:var(--accent); }
.form-group input, .form-group select, .form-group textarea {
  width:100%; padding:0.7rem 0.9rem;
  background:rgba(255,255,255,0.05); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--text-primary);
  font-size:0.9rem; font-family:var(--font);
  transition:border-color 0.22s ease, box-shadow 0.22s ease, background 0.22s ease; outline:none;
}
.form-group input:hover, .form-group select:hover { background:rgba(255,255,255,0.07); border-color:var(--border-strong); }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow), 0 2px 8px rgba(108,99,255,0.15);
  background:rgba(108,99,255,0.06);
}
.form-group select option { background:#1a1d2e; }
.form-group textarea { resize:vertical; min-height:80px; }

.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:0.5rem;
  padding:0.7rem 1.25rem; border-radius:var(--radius-sm);
  font-size:0.9rem; font-weight:600; font-family:var(--font);
  cursor:pointer; transition:transform 0.18s ease, box-shadow 0.18s ease, background 0.2s ease, border-color 0.2s ease;
  border:none; outline:none; will-change:transform;
}
.btn:active { transform:scale(0.96) !important; }
.btn-primary { background:linear-gradient(135deg, var(--accent), #8b5cf6); color:#fff; box-shadow:0 4px 20px var(--accent-glow); }
.btn-primary:hover { transform:translateY(-2px) scale(1.02); box-shadow:0 8px 28px var(--accent-glow); filter:brightness(1.08); }
.btn-full { width:100%; }
.btn-ghost { background:var(--bg-card); border:1px solid var(--border); color:var(--text-primary); }
.btn-ghost:hover { background:rgba(255,255,255,0.08); border-color:var(--border-strong); transform:translateY(-1px); }
.btn-danger { background:rgba(255,77,109,0.15); border:1px solid rgba(255,77,109,0.3); color:var(--danger); }
.btn-danger:hover { background:rgba(255,77,109,0.28); transform:translateY(-1px); box-shadow:0 4px 14px rgba(255,77,109,0.2); }
.btn-success { background:rgba(52,211,153,0.15); border:1px solid rgba(52,211,153,0.3); color:var(--success); }
.btn-success:hover { background:rgba(52,211,153,0.28); transform:translateY(-1px); }
.btn-sm { padding:0.45rem 0.9rem; font-size:0.8125rem; }

.auth-error {
  background:rgba(255,77,109,0.12); border:1px solid rgba(255,77,109,0.25);
  color:var(--danger); border-radius:var(--radius-sm);
  padding:0.65rem 0.9rem; font-size:0.85rem; margin-bottom:1rem; display:none;
  align-items:center; gap:0.5rem;
}

/* =============================================
   APP LAYOUT
   ============================================= */
#app { display:none; min-height:100vh; }

.sidebar {
  position:fixed; left:0; top:0; bottom:0; width:var(--sidebar-w);
  background:linear-gradient(180deg, rgba(13,15,24,0.98) 0%, rgba(8,10,16,0.98) 100%);
  border-right:1px solid var(--border); backdrop-filter:blur(20px);
  z-index:100; display:flex; flex-direction:column; transition:transform var(--transition);
}
.sidebar-logo {
  padding:1.5rem 1.25rem 1.25rem; display:flex; align-items:center; gap:0.75rem;
  border-bottom:1px solid var(--border);
}
.sidebar-logo .logo-mark {
  width:34px; height:34px;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius:8px; display:flex; align-items:center; justify-content:center;
  font-size:1rem; flex-shrink:0; box-shadow:0 4px 14px var(--accent-glow);
}
.sidebar-logo .logo-text { font-size:0.9rem; font-weight:700; line-height:1.2; }
.sidebar-logo .logo-text span { display:block; color:var(--text-muted); font-size:0.7rem; font-weight:400; }
.synced-badge { display:flex; align-items:center; gap:0.35rem; font-size:0.68rem; font-weight:600; color:var(--success); margin-top:0.3rem; }
.synced-dot { width:6px; height:6px; border-radius:50%; background:var(--success); box-shadow:0 0 6px var(--success); animation:pulse-dot 2s ease infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(0.8)} }

.sidebar-nav { flex:1; padding:1rem 0.75rem; overflow-y:auto; }
.nav-section-title { font-size:0.65rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; padding:0.75rem 0.5rem 0.4rem; }
.nav-item {
  display:flex; align-items:center; gap:0.75rem; padding:0.65rem 0.75rem;
  border-radius:var(--radius-sm); color:var(--text-secondary); font-size:0.875rem; font-weight:500;
  cursor:pointer; transition:var(--transition); margin-bottom:2px;
}
.nav-item:hover { background:var(--bg-card); color:var(--text-primary); }
.nav-item.active { background:rgba(108,99,255,0.15); color:var(--accent); border:1px solid rgba(108,99,255,0.2); }
.nav-item .nav-icon { font-size:1rem; width:20px; text-align:center; }

.sidebar-footer { padding:1rem 0.75rem; border-top:1px solid var(--border); }
.credits-sidebar-bar {
  padding:0.75rem; background:rgba(255,255,255,0.03); border-radius:var(--radius-sm);
  border:1px solid var(--border); margin-bottom:0.6rem; cursor:pointer; transition:var(--transition);
}
.credits-sidebar-bar:hover { border-color:var(--border-strong); background:rgba(255,255,255,0.06); }
.credits-bar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
.credits-bar-label { font-size:0.68rem; color:var(--text-muted); font-weight:500; text-transform:uppercase; letter-spacing:0.05em; }
.credits-bar-count { font-size:0.75rem; font-weight:700; }
.credits-bar-track { height:5px; background:rgba(255,255,255,0.07); border-radius:10px; overflow:hidden; }
.credits-bar-fill { height:100%; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width 0.5s ease; }
.credits-bar-sub { font-size:0.65rem; color:var(--text-muted); margin-top:0.4rem; }

.user-info-btn {
  display:flex; align-items:center; gap:0.75rem; padding:0.65rem 0.75rem;
  border-radius:var(--radius-sm); cursor:pointer; transition:var(--transition); border:1px solid transparent;
}
.user-info-btn:hover { background:var(--bg-card-hover); border-color:var(--border); }
.user-avatar-wrap { position:relative; flex-shrink:0; }
.user-avatar {
  width:34px; height:34px; border-radius:50%;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  display:flex; align-items:center; justify-content:center;
  font-size:0.8rem; font-weight:700; overflow:hidden;
}
.user-info-text { flex:1; min-width:0; }
.user-email { font-size:0.72rem; color:var(--text-secondary); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.user-role-label { font-size:0.65rem; color:var(--text-muted); margin-top:0.1rem; }

.sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:99; backdrop-filter:blur(4px); }

.main { margin-left:var(--sidebar-w); min-height:100vh; display:flex; flex-direction:column; }
.topbar {
  height:var(--topbar-h); display:flex; align-items:center; justify-content:space-between;
  padding:0 1.75rem; background:rgba(8,10,16,0.85); backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border); position:sticky; top:0; z-index:50;
}
.topbar-left { display:flex; align-items:center; gap:1rem; }
.menu-toggle { display:none; background:none; border:none; color:var(--text-primary); font-size:1.25rem; cursor:pointer; padding:0.25rem; }
.page-title { font-size:1.1rem; font-weight:600; }
.topbar-actions { display:flex; align-items:center; gap:0.65rem; }

.credits-chip {
  display:inline-flex; align-items:center; gap:0.35rem;
  padding:0.35rem 0.8rem; border-radius:20px; font-size:0.75rem; font-weight:600;
  background:rgba(108,99,255,0.1); border:1px solid rgba(108,99,255,0.25);
  cursor:pointer; transition:var(--transition); color:var(--accent);
}
.credits-chip:hover { background:rgba(108,99,255,0.2); border-color:var(--accent); }
.credits-chip.low { background:rgba(255,77,109,0.1); border-color:rgba(255,77,109,0.3); color:var(--danger); }

.plan-badge {
  display:inline-flex; align-items:center; gap:0.35rem;
  padding:0.3rem 0.7rem; border-radius:20px; font-size:0.7rem; font-weight:700;
  letter-spacing:0.04em; text-transform:uppercase;
}
.plan-free     { background:rgba(139,143,168,0.15); color:var(--text-secondary); border:1px solid rgba(139,143,168,0.2); }
.plan-pro      { background:rgba(108,99,255,0.18); color:var(--accent); border:1px solid rgba(108,99,255,0.3); }
.plan-advanced { background:rgba(0,212,170,0.15); color:var(--accent2); border:1px solid rgba(0,212,170,0.25); }
.plan-premium  { background:rgba(255,184,48,0.15); color:var(--warning); border:1px solid rgba(255,184,48,0.25); }
.plan-unlimited{ background:rgba(255,77,109,0.12); color:var(--danger); border:1px solid rgba(255,77,109,0.2); }

.content { flex:1; padding:1.75rem; max-width:1280px; }
.page { display:none; opacity:0; transform:translateY(14px); transition:opacity 0.3s ease-out,transform 0.3s ease-out; }
.page.active { display:block; animation:pageIn 0.32s ease-out both; }
@keyframes pageIn { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }

/* =============================================
   CARDS
   ============================================= */
.card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.5rem; backdrop-filter:blur(10px);
  transition:transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
  will-change:transform;
}
.card:hover { border-color:var(--border-strong); transform:scale(1.008) translateY(-1px); box-shadow:0 10px 36px rgba(0,0,0,0.3); }

/* =============================================
   STATS GRID
   ============================================= */
.stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
.stat-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.25rem 1.5rem; transition:var(--transition); position:relative; overflow:hidden;
}
.stat-card::before { content:''; position:absolute; top:-30px; right:-30px; width:80px; height:80px; border-radius:50%; opacity:0.12; }
.stat-card.s1::before { background:var(--accent); }
.stat-card.s2::before { background:var(--accent2); }
.stat-card.s3::before { background:var(--warning); }
.stat-card.s4::before { background:var(--success); }
.stat-card:hover { border-color:var(--border-strong); transform:translateY(-2px); }
.stat-label { font-size:0.775rem; color:var(--text-secondary); font-weight:500; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em; }
.stat-value { font-size:2rem; font-weight:700; letter-spacing:-0.03em; line-height:1; }
.stat-value.accent  { color:var(--accent); }
.stat-value.accent2 { color:var(--accent2); }
.stat-value.warning { color:var(--warning); }
.stat-value.success { color:var(--success); }
.stat-sub { font-size:0.775rem; color:var(--text-muted); margin-top:0.4rem; }

/* Credits stat card special */
.credits-stat-card {
  background:linear-gradient(135deg, rgba(108,99,255,0.12), rgba(0,212,170,0.08));
  border:1px solid rgba(108,99,255,0.25); border-radius:var(--radius); padding:1.25rem 1.5rem;
  position:relative; overflow:hidden; cursor:pointer; transition:var(--transition);
}
.credits-stat-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 8px 30px var(--accent-glow); }
.credits-stat-card .credits-big { font-size:2.4rem; font-weight:800; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

/* =============================================
   PROJECT CARDS
   ============================================= */
.projects-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:1rem; }
.project-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.4rem; transition:transform 0.25s ease,box-shadow 0.25s ease,border-color 0.25s ease;
  animation:fadeUp 0.35s ease both; backdrop-filter:blur(10px); will-change:transform;
}
.project-card:hover {
  border-color:var(--border-strong); transform:scale(1.02) translateY(-3px);
  box-shadow:0 16px 48px rgba(0,0,0,0.4), 0 0 0 1px rgba(108,99,255,0.1);
}
.project-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:1rem; }
.project-name { font-size:1rem; font-weight:600; }
.priority-badge { font-size:0.7rem; font-weight:600; padding:0.25rem 0.6rem; border-radius:20px; text-transform:uppercase; letter-spacing:0.05em; }
.priority-high   { background:rgba(255,77,109,0.15); color:var(--danger); border:1px solid rgba(255,77,109,0.25); }
.priority-medium { background:rgba(255,184,48,0.15); color:var(--warning); border:1px solid rgba(255,184,48,0.25); }
.priority-low    { background:rgba(52,211,153,0.15); color:var(--success); border:1px solid rgba(52,211,153,0.25); }

.countdown { display:flex; align-items:center; gap:0.5rem; font-size:0.825rem; margin-bottom:1rem; font-weight:500; }
.countdown-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.days-safe   { color:var(--success); } .dot-safe   { background:var(--success); }
.days-warn   { color:var(--warning); } .dot-warn   { background:var(--warning); }
.days-danger { color:var(--danger);  } .dot-danger { background:var(--danger); }

.progress-label { display:flex; justify-content:space-between; font-size:0.775rem; color:var(--text-secondary); margin-bottom:0.4rem; }
.progress-track { height:6px; background:rgba(255,255,255,0.07); border-radius:10px; overflow:hidden; margin-bottom:1rem; }
.progress-fill { height:100%; border-radius:10px; transition:width 0.6s ease; background:linear-gradient(90deg,var(--accent),var(--accent2)); }
.progress-fill.low  { background:linear-gradient(90deg,var(--danger),#ff8566); }
.progress-fill.mid  { background:linear-gradient(90deg,var(--warning),#ffde75); }
.progress-fill.good { background:linear-gradient(90deg,var(--success),#6ee7b7); }
.progress-slider { width:100%; accent-color:var(--accent); cursor:pointer; height:4px; margin-bottom:0.75rem; }

.alert-strip {
  background:rgba(255,77,109,0.1); border:1px solid rgba(255,77,109,0.2);
  border-radius:var(--radius-sm); padding:0.5rem 0.75rem;
  font-size:0.775rem; color:var(--danger); margin-bottom:0.75rem;
  display:flex; align-items:center; gap:0.5rem;
}
.project-actions { display:flex; gap:0.5rem; flex-wrap:wrap; }

/* =============================================
   SECTION HEADERS
   ============================================= */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem; }
.section-title { font-size:1rem; font-weight:600; }
.section-sub { font-size:0.8rem; color:var(--text-muted); margin-top:0.15rem; }

/* =============================================
   SESSION LOGGER
   ============================================= */
.log-form { display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:0.75rem; align-items:end; }
.log-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.85rem 1rem; background:var(--bg-card);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  margin-bottom:0.5rem; font-size:0.875rem; animation:fadeIn 0.3s ease;
  transition:transform 0.22s ease,box-shadow 0.22s ease,border-color 0.22s ease; will-change:transform;
}
.log-item:hover { transform:scale(1.012) translateX(3px); box-shadow:0 6px 24px rgba(0,0,0,0.28); border-color:var(--border-strong); }
.log-item-left { display:flex; flex-direction:column; gap:0.15rem; }
.log-project-name { font-weight:600; }
.log-meta { font-size:0.775rem; color:var(--text-secondary); }
.log-duration { font-size:1.1rem; font-weight:700; color:var(--accent2); display:flex; align-items:center; gap:0.3rem; }
.log-credits-used { font-size:0.7rem; color:var(--text-muted); margin-top:0.1rem; }

/* Credits cost preview */
.credit-cost-preview {
  background:rgba(108,99,255,0.08); border:1px solid rgba(108,99,255,0.2);
  border-radius:var(--radius-sm); padding:0.6rem 0.9rem;
  font-size:0.8rem; color:var(--accent); margin-bottom:0.75rem;
  display:flex; align-items:center; gap:0.5rem;
}

/* =============================================
   HEATMAP
   ============================================= */
.heatmap-grid { display:grid; grid-template-columns:repeat(53,1fr); gap:3px; overflow-x:auto; padding-bottom:0.5rem; }
.heatmap-week { display:grid; grid-template-rows:repeat(7,12px); gap:3px; }
.heatmap-day { width:12px; height:12px; border-radius:2px; background:rgba(255,255,255,0.06); transition:var(--transition); cursor:default; position:relative; }
.heatmap-day:hover::after {
  content:attr(data-tip); position:absolute; bottom:18px; left:50%; transform:translateX(-50%);
  background:#1e2030; border:1px solid var(--border); color:var(--text-primary);
  font-size:0.7rem; padding:0.3rem 0.6rem; border-radius:6px; white-space:nowrap; z-index:10; pointer-events:none;
}
.heat-1 { background:rgba(108,99,255,0.25); }
.heat-2 { background:rgba(108,99,255,0.45); }
.heat-3 { background:rgba(108,99,255,0.65); }
.heat-4 { background:rgba(108,99,255,0.85); }
.heatmap-legend { display:flex; align-items:center; gap:0.4rem; font-size:0.75rem; color:var(--text-muted); margin-top:0.75rem; justify-content:flex-end; }
.heatmap-legend-cell { width:12px; height:12px; border-radius:2px; }
.week-summary { display:grid; grid-template-columns:repeat(7,1fr); gap:0.5rem; margin-top:1rem; }
.day-bar { text-align:center; }
.day-bar-label { font-size:0.65rem; color:var(--text-muted); margin-bottom:0.3rem; }
.day-bar-track { height:60px; background:rgba(255,255,255,0.05); border-radius:4px; display:flex; align-items:flex-end; overflow:hidden; }
.day-bar-fill { width:100%; border-radius:4px 4px 0 0; background:linear-gradient(180deg,var(--accent2),rgba(0,212,170,0.4)); transition:height 0.6s ease; min-height:0; }
.day-bar-val { font-size:0.65rem; color:var(--text-secondary); margin-top:0.25rem; }

/* =============================================
   STORE PAGE
   ============================================= */
.store-hero { text-align:center; padding:1.5rem 0 2rem; }
.store-hero h2 { font-size:1.6rem; font-weight:700; margin-bottom:0.4rem; }
.store-hero p { color:var(--text-secondary); font-size:0.9rem; }
.store-hero .current-credits-display {
  display:inline-flex; align-items:center; gap:0.5rem; margin-top:0.75rem;
  padding:0.5rem 1.2rem; background:rgba(108,99,255,0.1); border:1px solid rgba(108,99,255,0.25);
  border-radius:20px; font-size:0.875rem; font-weight:600; color:var(--accent);
}

.plans-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; margin-bottom:2.5rem; }
.plan-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.5rem; transition:var(--transition); position:relative; cursor:pointer;
}
.plan-card:hover { border-color:var(--accent); transform:translateY(-3px); box-shadow:0 12px 40px rgba(108,99,255,0.2); }
.plan-card.current-plan { border-color:var(--accent2); background:rgba(0,212,170,0.05); }
.plan-card.popular-plan { border-color:var(--accent); background:rgba(108,99,255,0.05); }
.plan-card .plan-name { font-size:1rem; font-weight:700; margin-bottom:0.25rem; }
.plan-card .plan-price { font-size:1.75rem; font-weight:800; margin-bottom:0.25rem; }
.plan-card .plan-price span { font-size:0.9rem; font-weight:400; color:var(--text-muted); }
.plan-card .plan-features { font-size:0.8rem; color:var(--text-secondary); line-height:1.9; margin:0.75rem 0 1rem; list-style:none; }
.plan-card .plan-features li { display:flex; align-items:center; gap:0.4rem; }
.plan-card .plan-features li::before { content:'✓'; color:var(--success); font-weight:700; flex-shrink:0; }
.current-tag { position:absolute; top:0.75rem; right:0.75rem; background:var(--accent2); color:#000; font-size:0.65rem; font-weight:700; padding:0.2rem 0.5rem; border-radius:10px; text-transform:uppercase; }
.popular-tag { position:absolute; top:0.75rem; right:0.75rem; background:var(--accent); color:#fff; font-size:0.65rem; font-weight:700; padding:0.2rem 0.5rem; border-radius:10px; text-transform:uppercase; }

.credits-section { margin-top:0.5rem; }
.credits-section h3 { font-size:1rem; font-weight:600; margin-bottom:1rem; }
.credits-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:0.75rem; }
.credit-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.2rem; text-align:center; cursor:pointer; transition:var(--transition);
}
.credit-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 8px 28px rgba(108,99,255,0.2); }
.credit-card .credit-amount { font-size:1.5rem; font-weight:800; color:var(--accent); }
.credit-card .credit-label { font-size:0.72rem; color:var(--text-muted); margin-bottom:0.35rem; }
.credit-card .credit-price { font-size:1.05rem; font-weight:700; margin-top:0.35rem; }
.credit-card .credit-sessions { font-size:0.7rem; color:var(--accent2); margin-top:0.15rem; font-weight:500; }
.credit-card .credit-value { font-size:0.68rem; color:var(--text-muted); margin-top:0.1rem; }

/* =============================================
   ADMIN PANEL
   ============================================= */
.admin-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
.admin-table th { text-align:left; padding:0.6rem 0.75rem; color:var(--text-muted); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; border-bottom:1px solid var(--border); }
.admin-table td { padding:0.65rem 0.75rem; border-bottom:1px solid rgba(255,255,255,0.04); vertical-align:middle; }
.admin-table tr:hover td { background:rgba(255,255,255,0.03); }

/* =============================================
   MODAL
   ============================================= */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter:blur(8px); z-index:200; align-items:center; justify-content:center; padding:1.5rem; }
.modal-overlay.open { display:flex; }
.modal { background:#0f1118; border:1px solid var(--border-strong); border-radius:var(--radius); padding:2rem; width:100%; max-width:480px; box-shadow:0 30px 80px rgba(0,0,0,0.5); animation:fadeUp 0.3s ease; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
.modal-header h3 { font-size:1.1rem; font-weight:600; }
.modal-close { background:none; border:none; color:var(--text-secondary); font-size:1.25rem; cursor:pointer; transition:var(--transition); }
.modal-close:hover { color:var(--text-primary); }
/* =============================================
   AD MODAL STYLES
   ============================================= */
.ad-modal { max-width:520px; }
.ad-modal-info {
  background:rgba(108,99,255,0.08); border:1px solid rgba(108,99,255,0.2);
  border-radius:var(--radius-sm); padding:1rem; margin-bottom:1.25rem;
  font-size:0.875rem; color:var(--text-secondary); line-height:1.6;
}
.ad-modal-info strong { color:var(--text-primary); }

/* Ad progress ring */
.ad-progress-wrap {
  display:flex; flex-direction:column; align-items:center; padding:1.5rem 0 1rem;
}
.ad-ring-container { position:relative; width:110px; height:110px; margin-bottom:1rem; }
.ad-ring-svg { transform:rotate(-90deg); }
.ad-ring-bg   { fill:none; stroke:rgba(255,255,255,0.07); stroke-width:8; }
.ad-ring-fill { fill:none; stroke:url(#adGradient); stroke-width:8; stroke-linecap:round; transition:stroke-dashoffset 0.6s ease; }
.ad-ring-text { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.ad-ring-count { font-size:1.6rem; font-weight:800; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1; }
.ad-ring-of    { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
.ad-progress-label { font-size:0.8rem; color:var(--text-secondary); text-align:center; }
.ad-progress-label strong { color:var(--text-primary); }

/* Ad bar */
.ad-bar-wrap { width:100%; margin:0.75rem 0 1.25rem; }
.ad-bar-track { height:8px; background:rgba(255,255,255,0.07); border-radius:10px; overflow:hidden; }
.ad-bar-fill  { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:10px; transition:width 0.6s ease; }
.ad-bar-meta  { display:flex; justify-content:space-between; font-size:0.72rem; color:var(--text-muted); margin-top:0.4rem; }

/* Ad watch button */
.ad-watch-btn {
  display:flex; align-items:center; justify-content:center; gap:0.6rem;
  width:100%; padding:0.9rem; border-radius:var(--radius-sm);
  background:linear-gradient(135deg,var(--accent),#8b5cf6); color:#fff;
  font-size:0.95rem; font-weight:700; font-family:var(--font);
  border:none; cursor:pointer; transition:var(--transition); position:relative; overflow:hidden;
}
.ad-watch-btn:hover { transform:translateY(-2px); box-shadow:0 8px 28px var(--accent-glow); filter:brightness(1.08); }
.ad-watch-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.ad-watch-btn .ad-icon { font-size:1.1rem; }

/* Ad countdown overlay on button */
.ad-countdown-bar {
  position:absolute; left:0; top:0; height:100%;
  background:rgba(255,255,255,0.15); border-radius:var(--radius-sm);
  transition:width linear;
}

/* Completed state */
.ad-completed-banner {
  background:rgba(52,211,153,0.1); border:1px solid rgba(52,211,153,0.3);
  border-radius:var(--radius-sm); padding:0.85rem; text-align:center;
  font-size:0.875rem; color:var(--success); font-weight:600; margin-bottom:1rem;
  display:none; animation:fadeUp 0.4s ease;
}
.ad-completed-banner.show { display:block; }

/* Simulated ad frame */
.ad-frame {
  background:linear-gradient(135deg,rgba(108,99,255,0.12),rgba(0,212,170,0.08));
  border:1px solid rgba(108,99,255,0.25); border-radius:var(--radius-sm);
  padding:1.5rem; text-align:center; margin-bottom:1rem; min-height:120px;
  display:none; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem;
}
.ad-frame.playing { display:flex; animation:fadeIn 0.3s ease; }
.ad-frame-icon { font-size:2rem; }
.ad-frame-text { font-size:0.8rem; color:var(--text-muted); }
.ad-timer-pill {
  display:inline-flex; align-items:center; gap:0.4rem;
  background:rgba(0,0,0,0.4); padding:0.3rem 0.8rem; border-radius:20px;
  font-size:0.75rem; font-weight:700; color:var(--warning);
}

/* Credit card ad requirement tag */
.credit-card .credit-ad-req { font-size:0.72rem; color:var(--warning); margin-top:0.2rem; font-weight:600; }

/* Plan card ad requirement */
.plan-ad-req {
  display:flex; align-items:center; gap:0.4rem; font-size:0.75rem;
  color:var(--warning); margin-bottom:0.75rem; font-weight:600;
}
.plan-ad-progress { font-size:0.7rem; color:var(--text-muted); margin-bottom:0.75rem; }

/* =============================================
   DIALOGS
   ============================================= */
.dialog-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(12px); z-index:500; align-items:center; justify-content:center; padding:1.5rem; }
.dialog-overlay.open { display:flex; }
.dialog-box { background:#0f1118; border-radius:var(--radius); padding:2rem; width:100%; max-width:440px; box-shadow:0 30px 80px rgba(0,0,0,0.6); animation:fadeUp 0.3s ease; text-align:center; }
.dialog-box.danger-dialog { border:1px solid rgba(255,77,109,0.3); box-shadow:0 30px 80px rgba(255,77,109,0.12); }
.dialog-box.warning-dialog { border:1px solid rgba(255,184,48,0.3); box-shadow:0 30px 80px rgba(255,184,48,0.08); }
.dialog-box.info-dialog { border:1px solid rgba(108,99,255,0.3); box-shadow:0 30px 80px rgba(108,99,255,0.12); }
.dialog-icon { font-size:2.5rem; margin-bottom:1rem; }
.dialog-box h3 { font-size:1.15rem; font-weight:700; margin-bottom:0.6rem; }
.dialog-box p { color:var(--text-secondary); font-size:0.875rem; margin-bottom:1.5rem; line-height:1.6; }
.dialog-actions { display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap; }

/* =============================================
   PROFILE PANEL
   ============================================= */
.profile-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(6px); z-index:300; }
.profile-overlay.open { display:block; }
.profile-panel {
  position:fixed; top:0; right:0; bottom:0; width:380px; max-width:100vw;
  background:#0d0f18; border-left:1px solid var(--border-strong); z-index:301;
  display:flex; flex-direction:column; transform:translateX(100%);
  transition:transform 0.32s cubic-bezier(0.4,0,0.2,1); overflow-y:auto;
  box-shadow:-20px 0 60px rgba(0,0,0,0.5);
}
.profile-panel.open { transform:translateX(0); }
.profile-panel-header { display:flex; align-items:flex-start; justify-content:space-between; padding:1.75rem 1.5rem 1.25rem; border-bottom:1px solid var(--border); position:sticky; top:0; background:#0d0f18; z-index:2; }
.profile-panel-title { font-size:1.05rem; font-weight:700; }
.profile-panel-sub { font-size:0.775rem; color:var(--text-muted); margin-top:0.2rem; }
.profile-avatar-section { display:flex; flex-direction:column; align-items:center; padding:1.75rem 1.5rem 1rem; border-bottom:1px solid var(--border); }
.profile-avatar-wrap { position:relative; cursor:pointer; width:80px; height:80px; border-radius:50%; box-shadow:0 0 0 3px var(--border-strong),0 8px 28px rgba(0,0,0,0.4); transition:var(--transition); overflow:hidden; }
.profile-avatar-wrap:hover { box-shadow:0 0 0 3px var(--accent),0 8px 28px var(--accent-glow); }
.profile-avatar-circle { width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:700; color:#fff; }
#profile-avatar-img { width:80px; height:80px; border-radius:50%; object-fit:cover; position:absolute; inset:0; }
.profile-avatar-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; opacity:0; transition:var(--transition); color:#fff; }
.profile-avatar-wrap:hover .profile-avatar-overlay { opacity:1; }
.profile-avatar-hint { font-size:0.72rem; color:var(--text-muted); margin-top:0.65rem; }
.profile-sections { padding:0.5rem 1.5rem 2rem; flex:1; }
.profile-section { padding:1.25rem 0; border-bottom:1px solid var(--border); }
.profile-section:last-child { border-bottom:none; }
.profile-section-title { display:flex; align-items:center; gap:0.5rem; font-size:0.825rem; font-weight:600; color:var(--text-primary); margin-bottom:0.9rem; }
.profile-danger-desc { font-size:0.775rem; color:var(--text-muted); line-height:1.5; margin-bottom:0.85rem; background:rgba(255,184,48,0.06); border:1px solid rgba(255,184,48,0.12); border-radius:var(--radius-sm); padding:0.6rem 0.8rem; }
.pass-wrap { position:relative; }
.pass-wrap input { padding-right:2.5rem; }
.pass-toggle { position:absolute; right:0.7rem; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer; padding:0.2rem; transition:var(--transition); }
.pass-toggle:hover { color:var(--text-primary); }

/* =============================================
   LOADING & EMPTY STATES
   ============================================= */
.loader { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.2); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; }
.full-loader { display:flex; align-items:center; justify-content:center; min-height:200px; color:var(--text-muted); font-size:0.875rem; gap:0.75rem; }
.empty-state { text-align:center; padding:3rem 1.5rem; color:var(--text-muted); font-size:0.9rem; }
.empty-state .empty-icon { font-size:2.5rem; margin-bottom:0.75rem; }
.empty-state h3 { font-size:1rem; color:var(--text-secondary); margin-bottom:0.5rem; }

/* =============================================
   TOAST
   ============================================= */
#toast-container { position:fixed; bottom:1.5rem; right:1.5rem; z-index:999; display:flex; flex-direction:column; gap:0.5rem; }
.toast { background:rgba(18,20,30,0.97); border:1px solid var(--border-strong); border-radius:var(--radius-sm); padding:0.75rem 1.1rem; font-size:0.85rem; box-shadow:0 8px 30px rgba(0,0,0,0.5); display:flex; align-items:center; gap:0.6rem; min-width:240px; backdrop-filter:blur(16px); animation:toastIn 0.35s cubic-bezier(0.34,1.56,0.64,1) both; }
.toast.hiding { animation:toastOut 0.3s ease forwards; }
@keyframes toastIn  { from{opacity:0;transform:translateY(20px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
@keyframes toastOut { from{opacity:1;transform:translateY(0) scale(1)} to{opacity:0;transform:translateY(-10px) scale(0.95)} }
.toast.success { border-left:3px solid var(--success); }
.toast.error   { border-left:3px solid var(--danger); }
.toast.info    { border-left:3px solid var(--accent); }

/* =============================================
   SYNCING STATE
   ============================================= */
.synced-badge.syncing .synced-dot { animation:spin 0.8s linear infinite; border-radius:0; width:7px; height:7px; border:2px solid var(--success); border-top-color:transparent; background:transparent; box-shadow:none; }
.synced-badge.syncing { animation:syncPulse 1.2s ease infinite; }
@keyframes syncPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* =============================================
   BACKGROUND ORBS
   ============================================= */
.bg-orbs { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
.bg-orb  { position:absolute; border-radius:50%; filter:blur(80px); opacity:0.05; }
.orb1 { width:500px; height:500px; background:var(--accent); top:-100px; left:-100px; animation:orbFloat1 18s ease-in-out infinite; }
.orb2 { width:400px; height:400px; background:var(--accent2); bottom:-80px; right:-80px; animation:orbFloat2 22s ease-in-out infinite; }
.orb3 { width:300px; height:300px; background:#8b5cf6; top:40%; left:50%; animation:orbFloat3 26s ease-in-out infinite; }
@keyframes orbFloat1 { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(60px,40px) scale(1.08)} 66%{transform:translate(-30px,70px) scale(0.95)} }
@keyframes orbFloat2 { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(-50px,-40px) scale(1.1)} 66%{transform:translate(40px,-70px) scale(0.92)} }
@keyframes orbFloat3 { 0%,100%{transform:translate(-50%,-50%) scale(1)} 50%{transform:translate(-50%,-50%) scale(1.15) rotate(30deg)} }

/* =============================================
   ANIMATIONS
   ============================================= */
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes spin   { to{transform:rotate(360deg)} }

/* =============================================
   RESPONSIVE
   ============================================= */
@media (max-width:900px) {
  .stats-grid { grid-template-columns:repeat(2,1fr); }
  .log-form { grid-template-columns:1fr 1fr; }
  .log-form .btn { grid-column:span 2; }
}
@media (max-width:768px) {
  .sidebar { transform:translateX(calc(-1 * var(--sidebar-w))); }
  .sidebar.open { transform:translateX(0); }
  .sidebar-overlay.open { display:block; }
  .main { margin-left:0; }
  .menu-toggle { display:block; }
  .content { padding:1rem; }
  .stats-grid { grid-template-columns:repeat(2,1fr); gap:0.75rem; }
  .projects-grid { grid-template-columns:1fr; }
  .log-form { grid-template-columns:1fr; }
  .log-form .btn { grid-column:1; }
  .heatmap-grid { grid-template-columns:repeat(26,1fr); }
  .week-summary { grid-template-columns:repeat(7,1fr); gap:0.25rem; }
  .profile-panel { top:auto; left:0; right:0; bottom:0; width:100%; max-height:92vh; border-left:none; border-top:1px solid var(--border-strong); border-radius:20px 20px 0 0; transform:translateY(100%); }
  .profile-panel.open { transform:translateY(0); }
  .topbar-actions .plan-badge { display:none; }
}
@media (max-width:400px) {
  .stats-grid { grid-template-columns:1fr; }
  .auth-card { padding:1.5rem; }
  .topbar { padding:0 1rem; }
  .credits-grid { grid-template-columns:repeat(2,1fr); }
  .plans-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="logo-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      </div>
      <h1>FocusHub</h1>
      <p>Your premium productivity command center</p>
    </div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">Sign In</button>
        <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">Create Account</button>
      </div>
      <div id="auth-error" class="auth-error">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="auth-error-msg"></span>
      </div>
      <div id="form-login">
        <div class="form-group"><label>Email Address</label><input type="email" id="login-email" placeholder="you@example.com" /></div>
        <div class="form-group"><label>Password</label><input type="password" id="login-pass" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()" /></div>
        <button class="btn btn-primary btn-full" id="login-btn" onclick="doLogin()">Sign In</button>
      </div>
      <div id="form-signup" style="display:none">
        <div class="form-group"><label>Email Address</label><input type="email" id="signup-email" placeholder="you@example.com" /></div>
        <div class="form-group"><label>Password</label><input type="password" id="signup-pass" placeholder="Min 6 characters" onkeydown="if(event.key==='Enter')doSignup()" /></div>
        <button class="btn btn-primary btn-full" id="signup-btn" onclick="doSignup()">Create Account</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="bg-orbs" aria-hidden="true">
    <div class="bg-orb orb1"></div><div class="bg-orb orb2"></div><div class="bg-orb orb3"></div>
  </div>
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      </div>
      <div class="logo-text">FocusHub
        <span>Productivity Center</span>
        <div class="synced-badge" id="synced-badge"><span class="synced-dot"></span><span class="synced-label">Synced</span></div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-title">Navigation</div>
      <div class="nav-item active" onclick="navTo('dashboard')">
        <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>Dashboard
      </div>
      <div class="nav-item" onclick="navTo('projects')">
        <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg></span>Projects
      </div>
      <div class="nav-item" onclick="navTo('logger')">
        <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>Focus Logger
      </div>
      <div class="nav-item" onclick="navTo('heatmap')">
        <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>Activity Map
      </div>

      <div class="nav-item" id="nav-admin" style="display:none" onclick="navTo('admin')">
        <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>Admin Panel
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="credits-sidebar-bar" id="sidebar-credits-bar" style="cursor:default">
        <div class="credits-bar-header">
          <span class="credits-bar-label">Credits Remaining</span>
          <span class="credits-bar-count" id="sidebar-credits-count">—</span>
        </div>
        <div class="credits-bar-track"><div class="credits-bar-fill" id="sidebar-credits-fill" style="width:0%"></div></div>
        <div class="credits-bar-sub" id="sidebar-credits-sub">5 credits per 1-hour session</div>
      </div>
      <div class="user-info-btn" id="profile-trigger" onclick="openProfile()">
        <div class="user-avatar-wrap">
          <div class="user-avatar" id="user-avatar">?</div>
        </div>
        <div class="user-info-text">
          <div class="user-email" id="user-email-display">—</div>
          <div class="user-role-label" id="user-role-display"></div>
        </div>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;color:var(--text-muted)"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>
    <div style="padding:0.6rem 1rem 0.85rem;text-align:center;font-size:0.62rem;color:var(--text-muted);letter-spacing:0.02em;">
      Made with ❤️ by Varad Rudrakshawar
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="page-title" id="page-title">Dashboard</div>
      </div>
      <div class="topbar-actions">
        <span class="credits-chip" id="topbar-credits-chip" title="Weekly credits · resets every 7 days">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          <span id="topbar-credits">—</span> credits
        </span>
        <span class="plan-badge plan-free" id="topbar-plan-badge">Free</span>
        <button class="btn btn-primary btn-sm" onclick="openModal()">+ Add Project</button>
      </div>
    </header>

    <div class="content">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card s1">
            <div class="stat-label">Active Projects</div>
            <div class="stat-value accent" id="stat-total">—</div>
            <div class="stat-sub">Tracked projects</div>
          </div>
          <div class="stat-card s2">
            <div class="stat-label">Skill Progress</div>
            <div class="stat-value accent2" id="stat-progress">—%</div>
            <div class="stat-sub">Average completion</div>
          </div>
          <div class="stat-card s3">
            <div class="stat-label">Next Deadline</div>
            <div class="stat-value warning" id="stat-next">—</div>
            <div class="stat-sub" id="stat-next-name">No upcoming deadlines</div>
          </div>
          <div class="credits-stat-card" style="cursor:default">
            <div class="stat-label" style="color:var(--text-secondary)">Weekly Credits</div>
            <div class="credits-big" id="stat-credits">—</div>
            <div class="stat-sub">Resets every 7 days · 5 credits/hr</div>
          </div>
        </div>

        <div class="card" id="dashboard-projects-card">
          <div class="section-header">
            <div>
              <div class="section-title">Projects Overview</div>
              <div class="section-sub">All projects with deadline countdown</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="navTo('projects')">View All</button>
          </div>
          <div id="dashboard-projects-list">
            <div class="full-loader"><div class="loader"></div> Loading projects…</div>
          </div>
        </div>
      </div>

      <!-- PROJECTS PAGE -->
      <div class="page" id="page-projects">
        <div class="section-header">
          <div>
            <div class="section-title">All Projects</div>
            <div class="section-sub">Manage your work and track deadlines</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openModal()">+ Add Project</button>
        </div>
        <div class="projects-grid" id="projects-grid">
          <div class="full-loader"><div class="loader"></div> Loading projects…</div>
        </div>
      </div>

      <!-- FOCUS LOGGER PAGE -->
      <div class="page" id="page-logger">
        <div class="card" style="margin-bottom:1.25rem">
          <div class="section-header" style="margin-bottom:1rem">
            <div>
              <div class="section-title">Log Focus Session</div>
              <div class="section-sub">Record your work time — 5 credits per hour</div>
            </div>
            <span class="credits-chip" id="logger-credits-display" title="Weekly credits · resets every 7 days">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
              <span id="logger-credits-count">—</span> credits
            </span>
          </div>
          <div id="credit-cost-preview" class="credit-cost-preview" style="display:none">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            <span id="credit-cost-text">This session will use 0 credits</span>
          </div>
          <div class="log-form" id="log-form">
            <div class="form-group" style="margin:0">
              <label>Project</label>
              <select id="log-project" onchange="updateCreditPreview()">
                <option value="">Select project…</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label>Session Date</label>
              <input type="date" id="log-date" />
            </div>
            <div class="form-group" style="margin:0">
              <label>Duration (minutes)</label>
              <input type="number" id="log-duration" placeholder="e.g. 90" min="1" max="720" oninput="updateCreditPreview()" />
            </div>
            <button class="btn btn-primary" onclick="addLog()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
              Log Session
            </button>
          </div>
        </div>
        <div class="section-header">
          <div class="section-title">Recent Sessions</div>
        </div>
        <div id="log-list">
          <div class="full-loader"><div class="loader"></div> Loading sessions…</div>
        </div>
      </div>

      <!-- ACTIVITY MAP PAGE -->
      <div class="page" id="page-heatmap">
        <div class="card" style="margin-bottom:1.25rem">
          <div class="section-header" style="margin-bottom:1.25rem">
            <div>
              <div class="section-title">Focus Activity Map</div>
              <div class="section-sub">Your productivity pattern over the past year</div>
            </div>
          </div>
          <div id="heatmap-container">
            <div class="full-loader"><div class="loader"></div> Generating activity map…</div>
          </div>
          <div class="heatmap-legend">
            Less
            <div class="heatmap-legend-cell" style="background:rgba(255,255,255,0.06)"></div>
            <div class="heatmap-legend-cell heat-1"></div>
            <div class="heatmap-legend-cell heat-2"></div>
            <div class="heatmap-legend-cell heat-3"></div>
            <div class="heatmap-legend-cell heat-4"></div>
            More
          </div>
        </div>
        <div class="card">
          <div class="section-header" style="margin-bottom:1rem">
            <div class="section-title">This Week at a Glance</div>
          </div>
          <div class="week-summary" id="week-summary"></div>
        </div>
      </div>

      <!-- Store page removed -->
      <div class="page" id="page-store" style="display:none"></div>

      <!-- ADMIN PAGE — only rendered for admin email -->
      <div class="page" id="page-admin" data-admin-only="true">
        <div class="section-header">
          <div><div class="section-title">🛡️ Admin Panel</div><div class="section-sub">Manage users, weekly credits, and exceptions</div></div>
          <button class="btn btn-ghost btn-sm" onclick="loadAdminData()">↻ Refresh</button>
        </div>
        <div class="card" style="overflow-x:auto;margin-bottom:1.25rem">
          <table class="admin-table" id="admin-users-table">
            <thead><tr>
              <th>Email</th><th>Plan</th><th>Credits</th><th>Last Reset</th><th>Role</th><th>Actions</th>
            </tr></thead>
            <tbody id="admin-users-body">
              <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">Click Refresh to load users</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card">
          <div class="section-title" style="margin-bottom:1rem">⭐ Exception Users</div>
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem">Exception users get unlimited credits and projects.</p>
          <div id="admin-exceptions-list" style="margin-bottom:0.75rem"></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
            <input type="email" id="admin-add-exception-email" placeholder="user@email.com" style="flex:1;min-width:200px;padding:0.6rem 0.8rem;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:0.875rem;outline:none;font-family:var(--font)" />
            <button class="btn btn-primary btn-sm" onclick="adminAddException()">Add Exception</button>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- ADD PROJECT MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>Add New Project</h3>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="form-group">
      <label>Project Name</label>
      <input type="text" id="sub-name" placeholder="e.g. Website Redesign" />
    </div>
    <div class="form-group">
      <label>Deadline</label>
      <input type="date" id="sub-date" />
    </div>
    <div class="form-group">
      <label>Priority</label>
      <select id="sub-priority">
        <option value="high">High Priority</option>
        <option value="medium">Medium Priority</option>
        <option value="low">Low Priority</option>
      </select>
    </div>
    <div class="form-group">
      <label>Initial Progress: <span id="prog-label">0%</span></label>
      <input type="range" class="progress-slider" id="sub-progress" min="0" max="100" value="0" oninput="document.getElementById('prog-label').textContent=this.value+'%'" />
    </div>
    <button class="btn btn-primary btn-full" id="add-sub-btn" onclick="addSubject()">Add Project</button>
  </div>
</div>

<!-- PROFILE PANEL -->
<input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarChange(event)" />
<div class="profile-overlay" id="profile-overlay" onclick="closeProfile()"></div>
<div class="profile-panel" id="profile-panel">
  <div class="profile-panel-header">
    <div>
      <div class="profile-panel-title">My Profile</div>
      <div class="profile-panel-sub">Manage your account settings</div>
    </div>
    <button class="modal-close" onclick="closeProfile()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="profile-avatar-section">
    <div class="profile-avatar-wrap" onclick="document.getElementById('avatar-file-input').click()" title="Click to change photo">
      <div class="profile-avatar-circle" id="profile-avatar-circle">?</div>
      <img id="profile-avatar-img" src="" alt="" style="display:none" />
      <div class="profile-avatar-overlay">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      </div>
    </div>
    <div class="profile-avatar-hint">Click to change photo</div>
  </div>
  <div class="profile-sections">
    <div class="profile-section">
      <div class="profile-section-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Change Email
      </div>
      <div class="form-group" style="margin-bottom:0.6rem">
        <label>New Email Address</label>
        <input type="email" id="profile-new-email" placeholder="newemail@example.com" />
      </div>
      <button class="btn btn-ghost btn-sm" id="btn-change-email" onclick="changeEmail()">Update Email</button>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Change Password
      </div>
      <div class="form-group" style="margin-bottom:0.6rem">
        <label>New Password</label>
        <div class="pass-wrap">
          <input type="password" id="profile-new-pass" placeholder="Min 6 characters" />
          <button class="pass-toggle" onclick="togglePassVis('profile-new-pass',this)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:0.6rem">
        <label>Confirm Password</label>
        <div class="pass-wrap">
          <input type="password" id="profile-confirm-pass" placeholder="Repeat password" />
          <button class="pass-toggle" onclick="togglePassVis('profile-confirm-pass',this)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" id="btn-change-pass" onclick="changePassword()">Update Password</button>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Role / Title
      </div>
      <div class="form-group" style="margin-bottom:0.6rem">
        <label>Your Role</label>
        <input type="text" id="profile-class" placeholder="e.g. Freelancer / Developer / Student" />
      </div>
      <button class="btn btn-ghost btn-sm" id="btn-save-class" onclick="saveClass()">Save Role</button>
    </div>
    <div class="profile-section">
      <div class="profile-section-title" style="color:var(--warning)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.51"/></svg>
        Reset Progress
      </div>
      <p class="profile-danger-desc">Reset skill progress on all projects to 0%. Projects and sessions are not deleted.</p>
      <button class="btn btn-sm" style="background:rgba(255,184,48,0.1);border:1px solid rgba(255,184,48,0.25);color:var(--warning)" id="btn-reset-progress" onclick="confirmResetProgress()">Reset All Progress</button>
    </div>
    <div class="profile-section" style="border:none;padding-top:0">
      <button class="btn btn-danger btn-full" onclick="doLogout()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>


<!-- CREDITS EMPTY DIALOG -->
<div class="dialog-overlay" id="credits-empty-dialog">
  <div class="dialog-box danger-dialog">
    <div class="dialog-icon">⚡</div>
    <h3>Weekly Limit Reached</h3>
    <p>You have reached your weekly credit limit. Credits will reset automatically every 7 days. Your sessions and data are safely saved.</p>
    <div class="dialog-actions">
      <button class="btn btn-primary" onclick="closeCreditsDialog()">Got It</button>
    </div>
  </div>
</div>

<!-- PROJECT LIMIT DIALOG -->
<div class="dialog-overlay" id="project-limit-dialog">
  <div class="dialog-box warning-dialog">
    <div class="dialog-icon">🗂️</div>
    <h3>Project Limit Reached</h3>
    <p id="project-limit-msg">Your plan allows a limited number of projects. Delete the oldest project to add a new one?</p>
    <div class="dialog-actions">
      <button class="btn btn-danger" onclick="confirmDeleteFirst()">Delete Oldest & Continue</button>
      <button class="btn btn-ghost" onclick="closeProjectLimitDialog()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =============================================
   SUPABASE CONFIGURATION
   ============================================= */
const SUPABASE_URL  = "https://pofpbmuepdxguvliwxtp.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZnBibXVlcGR4Z3V2bGl3eHRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTc1MDAsImV4cCI6MjA4NzY3MzUwMH0.XLQ0W99lgBWGSNOpgUKwp9KAphhNirbYaWkeZE0JcNk";
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

/* =============================================
   APP CONFIGURATION
   ============================================= */
const ADMIN_EMAIL      = 'varadrudrakshawar2011@gmail.com'; // ← SET YOUR ADMIN EMAIL
const EXCEPTION_EMAILS = [];

const CREDITS_PER_HOUR  = 5;   // credits consumed per 1-hour session
const WEEKLY_CREDITS    = 150; // normal user weekly allowance
const WEEKLY_RESET_DAYS = 7;   // days before auto-reset

// Only 'free'/Member plan for normal users
const PLANS = {
  free: { name:'Member', maxProjects:Infinity, startCredits:WEEKLY_CREDITS, color:'plan-free' },
};

/* =============================================
   APP STATE
   ============================================= */
let currentUser  = null;
let allProjects  = [];
let allLogs      = [];
let currentPage  = 'dashboard';
let profileData  = { photoDataUrl:null, userClass:'' };
let pendingAddProjectData = null;

let userAccount = {
  plan:    'free',
  credits: WEEKLY_CREDITS,
  role:    'user',
};

/* =============================================
   UTILITIES
   ============================================= */
function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icons = {
    success: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
    error:   `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff4d6d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
    info:    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6c63ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`
  };
  el.innerHTML = `<span>${icons[type]||icons.info}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => { el.classList.add('hiding'); el.addEventListener('animationend', ()=>el.remove(), {once:true}); }, 3500);
}

function setSyncing(on) {
  const badge = document.getElementById('synced-badge');
  const label = badge?.querySelector('.synced-label');
  if (!badge) return;
  if (on) { badge.classList.add('syncing'); if(label) label.textContent='Syncing…'; }
  else    { badge.classList.remove('syncing'); if(label) label.textContent='Synced'; }
}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (loading) { btn.dataset.orig = btn.innerHTML; btn.innerHTML = '<span class="loader"></span>'; btn.disabled = true; }
  else { btn.innerHTML = btn.dataset.orig || btn.innerHTML; btn.disabled = false; }
}

function daysUntil(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  return Math.ceil((new Date(dateStr) - today) / 86400000);
}

function fmt(dateStr) {
  return new Date(dateStr).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

function countdownClass(days) {
  if (days <= 7)  return 'danger';
  if (days <= 21) return 'warn';
  return 'safe';
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function calcCreditsForSession(minutes) {
  return Math.ceil((minutes / 60) * CREDITS_PER_HOUR);
}

/* =============================================
   ROLE / PLAN HELPERS
   ============================================= */
function getUserRole(email) {
  if (!email) return 'user';
  if (email === ADMIN_EMAIL) return 'admin';
  if (EXCEPTION_EMAILS.includes(email)) return 'exception';
  return 'user';
}
function isUnlimited() {
  return userAccount.role === 'admin' || userAccount.role === 'exception';
}

/* =============================================
   AUTH
   ============================================= */
function switchTab(tab) {
  document.getElementById('form-login').style.display  = tab==='login'  ? '' : 'none';
  document.getElementById('form-signup').style.display = tab==='signup' ? '' : 'none';
  document.getElementById('tab-login').classList.toggle('active',  tab==='login');
  document.getElementById('tab-signup').classList.toggle('active', tab==='signup');
  const errEl = document.getElementById('auth-error');
  errEl.style.display = 'none'; errEl.style.background=''; errEl.style.borderColor=''; errEl.style.color='';
}

function showAuthError(msg, success=false) {
  const el = document.getElementById('auth-error');
  el.style.display = 'flex';
  if (success) { el.style.background='rgba(52,211,153,0.1)'; el.style.borderColor='rgba(52,211,153,0.3)'; el.style.color='var(--success)'; }
  else { el.style.background=''; el.style.borderColor=''; el.style.color=''; }
  document.getElementById('auth-error-msg').textContent = msg;
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  if (!email || !pass) return showAuthError('Please fill in all fields.');
  setLoading('login-btn', true);
  const { error } = await sb.auth.signInWithPassword({ email, password:pass });
  setLoading('login-btn', false);
  if (error) showAuthError(error.message);
}

async function doSignup() {
  const email = document.getElementById('signup-email').value.trim();
  const pass  = document.getElementById('signup-pass').value;
  if (!email || !pass) return showAuthError('Please fill in all fields.');
  if (pass.length < 6) return showAuthError('Password must be at least 6 characters.');
  setLoading('signup-btn', true);
  const { data, error } = await sb.auth.signUp({ email, password:pass, options:{ data:{ email } } });
  setLoading('signup-btn', false);
  if (error) { showAuthError(error.message); return; }
  if (data.user && !data.session) { showAuthError('✅ Account created! Check your email to confirm, then sign in.', true); return; }
  toast('Welcome to FocusHub!', 'success');
}

async function doLogout() {
  await sb.auth.signOut();
}

/* =============================================
   SESSION MANAGEMENT
   ============================================= */
sb.auth.onAuthStateChange(async (event, session) => {
  if (session?.user) { currentUser = session.user; showApp(); }
  else { currentUser = null; showAuth(); }
});

function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

async function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  const email = currentUser.email;
  document.getElementById('user-email-display').textContent = email;
  document.getElementById('user-avatar').textContent = email[0].toUpperCase();
  document.getElementById('log-date').value = new Date().toISOString().split('T')[0];
  await loadUserAccount();
  await loadAll();
}

/* =============================================
   LOAD USER ACCOUNT
   ============================================= */
async function loadUserAccount() {
  if (!currentUser) return;

  // Load exception list
  const { data: excData } = await sb.from('exception_users').select('email');
  if (excData) { EXCEPTION_EMAILS.length = 0; excData.forEach(e => EXCEPTION_EMAILS.push(e.email)); }

  const role = getUserRole(currentUser.email);
  userAccount.role = role;

  if (role === 'admin' || role === 'exception') {
    userAccount.plan    = 'free';
    userAccount.credits = 999999;
    if (role === 'admin') document.getElementById('nav-admin').style.display = '';
  } else {
    // Normal user — weekly reset logic
    const { data, error } = await sb.from('user_accounts').select('*').eq('user_id', currentUser.id).single();
    if (error && error.code === 'PGRST116') {
      await sb.from('user_accounts').insert({
        user_id: currentUser.id, email: currentUser.email,
        plan: 'free', weekly_credits: WEEKLY_CREDITS, extra_credits: 0,
        weekly_reset_at: new Date().toISOString(),
      });
      userAccount = { ...userAccount, plan:'free', credits: WEEKLY_CREDITS };
    } else if (data) {
      const lastReset = data.weekly_reset_at ? new Date(data.weekly_reset_at) : new Date(0);
      const daysSince = (new Date() - lastReset) / (1000 * 60 * 60 * 24);
      if (daysSince >= WEEKLY_RESET_DAYS) {
        await sb.from('user_accounts').update({
          weekly_credits: WEEKLY_CREDITS, extra_credits: 0,
          weekly_reset_at: new Date().toISOString(), plan: 'free',
        }).eq('user_id', currentUser.id);
        userAccount = { ...userAccount, plan:'free', credits: WEEKLY_CREDITS };
        toast('\u{1F504} Weekly credits reset to 150!', 'info');
      } else {
        userAccount = { ...userAccount, plan:'free', credits: data.weekly_credits ?? WEEKLY_CREDITS };
      }
    }
  }
  updatePlanUI();
}

/* =============================================
   UPDATE PLAN UI
   ============================================= */
function updatePlanUI() {
  const credits = isUnlimited() ? '∞' : userAccount.credits;
  const isLow   = !isUnlimited() && userAccount.credits < 15;

  // Topbar badge
  const badge = document.getElementById('topbar-plan-badge');
  if (badge) {
    badge.textContent = isUnlimited() ? (userAccount.role==='admin' ? '👑 Admin' : '⭐ Exception') : 'Member';
    badge.className   = 'plan-badge ' + (userAccount.role==='admin' ? 'plan-unlimited' : userAccount.role==='exception' ? 'plan-premium' : 'plan-free');
  }

  // Topbar credits chip (no store link)
  const chip = document.getElementById('topbar-credits-chip');
  const topC = document.getElementById('topbar-credits');
  if (topC) topC.textContent = credits;
  if (chip) { chip.className = 'credits-chip' + (isLow ? ' low' : ''); chip.onclick = null; chip.style.cursor = 'default'; }

  // Sidebar credits bar
  const count = document.getElementById('sidebar-credits-count');
  const fill  = document.getElementById('sidebar-credits-fill');
  const sub   = document.getElementById('sidebar-credits-sub');
  if (count) count.textContent = credits;
  if (fill) {
    const maxC = isUnlimited() ? 100 : WEEKLY_CREDITS;
    const pct  = isUnlimited() ? 100 : Math.min(100, Math.max(0, (userAccount.credits / maxC) * 100));
    fill.style.width = pct + '%';
    fill.style.background = pct < 20 ? 'var(--danger)' : pct < 40 ? 'var(--warning)' : 'linear-gradient(90deg,var(--accent),var(--accent2))';
  }
  if (sub) sub.textContent = isUnlimited() ? 'Unlimited access' : `Resets weekly · ${CREDITS_PER_HOUR} per hour`;

  // Logger credits display
  const loggerCount = document.getElementById('logger-credits-count');
  if (loggerCount) loggerCount.textContent = credits;
  const loggerChip = document.getElementById('logger-credits-display');
  if (loggerChip) { loggerChip.className = 'credits-chip' + (isLow ? ' low' : ''); loggerChip.onclick = null; loggerChip.style.cursor = 'default'; }

  // Dashboard credits stat
  const statC = document.getElementById('stat-credits');
  if (statC) statC.textContent = credits;

  // Role display in sidebar
  const roleEl = document.getElementById('user-role-display');
  if (roleEl) {
    roleEl.textContent = isUnlimited() ? (userAccount.role==='admin' ? 'Administrator' : 'Exception User') : 'Member';
  }
}

/* =============================================
   CREDIT CONSUMPTION
   ============================================= */
async function consumeCredits(amount) {
  if (isUnlimited()) return true;
  if (userAccount.credits < amount) {
    showCreditsEmptyDialog();
    return false;
  }
  userAccount.credits -= amount;

  // Update Supabase — deduct from weekly_credits only
  const { data } = await sb.from('user_accounts').select('weekly_credits').eq('user_id', currentUser.id).single();
  if (data) {
    const newWc = Math.max(0, (data.weekly_credits || 0) - amount);
    await sb.from('user_accounts').update({ weekly_credits: newWc }).eq('user_id', currentUser.id);
  }

  // Log transaction
  await sb.from('credit_transactions').insert({
    user_id: currentUser.id, type:'spend', amount:-amount,
    balance_after: userAccount.credits, description:`Focus session — ${amount} credits used`,
  }).catch(()=>{});

  updatePlanUI();
  return true;
}

/* =============================================
   DIALOGS
   ============================================= */
function showCreditsEmptyDialog() {
  document.getElementById('credits-empty-dialog').classList.add('open');
}
function closeCreditsDialog() {
  document.getElementById('credits-empty-dialog').classList.remove('open');
}

function showProjectLimitDialog(newProjectData) {
  pendingAddProjectData = newProjectData;
  document.getElementById('project-limit-msg').textContent =
    'Your oldest project will be permanently deleted to make room. This cannot be undone.';
  document.getElementById('project-limit-dialog').classList.add('open');
}
function closeProjectLimitDialog() {
  document.getElementById('project-limit-dialog').classList.remove('open');
  pendingAddProjectData = null;
}

async function confirmDeleteFirst() {
  closeProjectLimitDialog();
  if (!pendingAddProjectData) return;
  const oldest = [...allProjects].sort((a,b)=>new Date(a.created_at||0)-new Date(b.created_at||0))[0];
  if (!oldest) { toast('No projects to delete.','error'); return; }
  setSyncing(true);
  await sb.from('study_logs').delete().eq('subject_id', oldest.id).eq('user_id', currentUser.id);
  await sb.from('subjects').delete().eq('id', oldest.id).eq('user_id', currentUser.id);
  setSyncing(false);
  toast(`Deleted "${oldest.subject_name}". Adding new project…`, 'info');
  await doInsertProject(pendingAddProjectData);
  pendingAddProjectData = null;
}

/* =============================================
   DATA LOADING
   ============================================= */
async function loadAll() {
  await Promise.all([loadProjects(), loadLogs()]);
  renderAll();
}

async function loadProjects() {
  const { data, error } = await sb.from('subjects').select('*').eq('user_id', currentUser.id).order('exam_date', {ascending:true});
  if (error) { toast('Error loading projects: ' + error.message, 'error'); return; }
  allProjects = data || [];
}

async function loadLogs() {
  const { data, error } = await sb.from('study_logs').select('*, subjects(subject_name)').eq('user_id', currentUser.id).order('study_date', {ascending:false});
  if (error) { toast('Error loading sessions: ' + error.message, 'error'); return; }
  allLogs = data || [];
}

/* =============================================
   RENDER EVERYTHING
   ============================================= */
function renderAll() {
  renderStats();
  renderDashboardList();
  renderProjectsGrid();
  renderLogList();
  renderLogProjectSelect();
  renderHeatmap();
  renderWeekSummary();
  updatePlanUI();
}

function renderStats() {
  document.getElementById('stat-total').textContent = allProjects.length;

  const avg = allProjects.length ? Math.round(allProjects.reduce((s,x)=>s+(x.progress||0),0)/allProjects.length) : 0;
  document.getElementById('stat-progress').textContent = avg + '%';

  const upcoming = allProjects.filter(s=>daysUntil(s.exam_date)>=0).sort((a,b)=>daysUntil(a.exam_date)-daysUntil(b.exam_date));
  if (upcoming.length) {
    const d = daysUntil(upcoming[0].exam_date);
    document.getElementById('stat-next').textContent = d===0?'Today':d+'d';
    document.getElementById('stat-next-name').textContent = upcoming[0].subject_name;
  } else {
    document.getElementById('stat-next').textContent = '—';
    document.getElementById('stat-next-name').textContent = 'No upcoming deadlines';
  }
}

function renderDashboardList() {
  const el = document.getElementById('dashboard-projects-list');
  if (!allProjects.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">🗂️</div><h3>No projects yet</h3><p>Add your first project to get started.</p></div>`;
    return;
  }
  el.innerHTML = allProjects.slice(0,4).map(s=>buildProjectCard(s,true)).join('');
}

function renderProjectsGrid() {
  const el = document.getElementById('projects-grid');
  if (!allProjects.length) {
    el.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">🗂️</div><h3>No projects yet</h3><p>Click "+ Add Project" to begin tracking your work.</p></div>`;
    return;
  }
  el.innerHTML = allProjects.map(s=>buildProjectCard(s,true)).join('');
}

function buildProjectCard(s, withDelete=false) {
  const days = daysUntil(s.exam_date);
  const cls  = countdownClass(days);
  const prog = s.progress || 0;
  let progClass = prog<30?'low':prog<70?'mid':'good';
  const alert = days<=14 && prog<50
    ? `<div class="alert-strip"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Deadline soon — pick up the pace!</div>` : '';
  const dayText = days<0?`${Math.abs(days)} days overdue`:days===0?'Due Today!':`${days} days left`;

  return `<div class="project-card">
    <div class="project-header">
      <div>
        <div class="project-name">${escHtml(s.subject_name)}</div>
        <div style="font-size:0.775rem;color:var(--text-muted);margin-top:0.2rem">${fmt(s.exam_date)}</div>
      </div>
      <span class="priority-badge priority-${s.priority}">${s.priority}</span>
    </div>
    <div class="countdown">
      <span class="countdown-dot dot-${cls}"></span>
      <span class="days-${cls}">${dayText}</span>
    </div>
    ${alert}
    <div class="progress-label"><span>Skill Progress</span><span>${prog}%</span></div>
    <div class="progress-track"><div class="progress-fill ${progClass}" style="width:${prog}%"></div></div>
    <input type="range" class="progress-slider" value="${prog}" min="0" max="100"
      onchange="updateProgress('${s.id}',this.value,this)"
      oninput="this.previousElementSibling.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';this.previousElementSibling.querySelector('.progress-fill').style.width=this.value+'%'" />
    <div class="project-actions">
      <button class="btn btn-ghost btn-sm" onclick="openLogForProject('${s.id}')">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Log Session
      </button>
      ${withDelete ? `<button class="btn btn-danger btn-sm" onclick="deleteProject('${s.id}')">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg> Remove
      </button>` : ''}
    </div>
  </div>`;
}

function renderLogList() {
  const el = document.getElementById('log-list');
  if (!allLogs.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">⏱️</div><h3>No sessions logged yet</h3><p>Log your first focus session above.</p></div>`;
    return;
  }
  el.innerHTML = allLogs.slice(0,30).map(l => {
    const mins = l.duration_minutes;
    const credUsed = calcCreditsForSession(mins);
    return `<div class="log-item">
      <div class="log-item-left">
        <div class="log-project-name">${escHtml(l.subjects?.subject_name||'Unknown')}</div>
        <div class="log-meta">${fmt(l.study_date)}</div>
      </div>
      <div style="text-align:right">
        <div class="log-duration">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          ${mins>=60?`${Math.floor(mins/60)}h ${mins%60}m`:`${mins}m`}
        </div>
        <div class="log-credits-used">−${credUsed} credits</div>
      </div>
    </div>`;
  }).join('');
}

function renderLogProjectSelect() {
  const sel = document.getElementById('log-project');
  sel.innerHTML = '<option value="">Select project…</option>' +
    allProjects.map(s=>`<option value="${s.id}">${escHtml(s.subject_name)}</option>`).join('');
}

function updateCreditPreview() {
  const mins = parseInt(document.getElementById('log-duration').value) || 0;
  const preview = document.getElementById('credit-cost-preview');
  const text    = document.getElementById('credit-cost-text');
  if (mins > 0 && !isUnlimited()) {
    const cost = calcCreditsForSession(mins);
    const remaining = userAccount.credits;
    preview.style.display = 'flex';
    if (remaining < cost) {
      preview.style.background = 'rgba(255,77,109,0.08)';
      preview.style.borderColor = 'rgba(255,77,109,0.25)';
      preview.style.color = 'var(--danger)';
      text.textContent = `⚠️ This session costs ${cost} credits but you only have ${remaining}`;
    } else {
      preview.style.background = '';
      preview.style.borderColor = '';
      preview.style.color = '';
      text.textContent = `This session will use ${cost} credits (${remaining - cost} remaining after)`;
    }
  } else {
    preview.style.display = 'none';
  }
}

function renderHeatmap() {
  const container = document.getElementById('heatmap-container');
  const dayMap = {};
  allLogs.forEach(l => { dayMap[l.study_date] = (dayMap[l.study_date]||0)+(l.duration_minutes||0); });
  const maxMins = Math.max(...Object.values(dayMap), 1);
  const today = new Date(); today.setHours(0,0,0,0);
  const start = new Date(today); start.setDate(start.getDate()-364); start.setDate(start.getDate()-start.getDay());
  let html = '<div class="heatmap-grid">';
  let d = new Date(start);
  while (d <= today) {
    html += '<div class="heatmap-week">';
    for (let i=0; i<7; i++) {
      const key = d.toISOString().split('T')[0];
      const mins = dayMap[key]||0;
      let heat = '';
      if (mins>0) { const r=mins/maxMins; heat=r<0.25?'heat-1':r<0.5?'heat-2':r<0.75?'heat-3':'heat-4'; }
      const tip = mins?`${key}: ${mins}m`:key;
      html += `<div class="heatmap-day ${heat}" data-tip="${tip}" title="${tip}"></div>`;
      d.setDate(d.getDate()+1);
    }
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function renderWeekSummary() {
  const el = document.getElementById('week-summary');
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const today = new Date(); today.setHours(0,0,0,0);
  const weekData = [];
  for (let i=6; i>=0; i--) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    const key = d.toISOString().split('T')[0];
    const mins = allLogs.filter(l=>l.study_date===key).reduce((s,l)=>s+(l.duration_minutes||0),0);
    weekData.push({ day:days[d.getDay()], mins });
  }
  const maxM = Math.max(...weekData.map(x=>x.mins),1);
  el.innerHTML = weekData.map(x => {
    const h = Math.round((x.mins/maxM)*60);
    const label = x.mins>=60?`${(x.mins/60).toFixed(1)}h`:x.mins?`${x.mins}m`:'—';
    return `<div class="day-bar">
      <div class="day-bar-label">${x.day}</div>
      <div class="day-bar-track"><div class="day-bar-fill" style="height:${h}px"></div></div>
      <div class="day-bar-val">${label}</div>
    </div>`;
  }).join('');
}

/* =============================================
   NAVIGATION
   ============================================= */
const pageTitles = {
  dashboard:'Dashboard', projects:'Projects', logger:'Focus Logger',
  heatmap:'Activity Map', admin:'Admin Panel',
};

function navTo(page) {
  // Block admin page for non-admin users — hard guard at navigation level
  if (page === 'admin' && (userAccount.role !== 'admin' || currentUser?.email !== ADMIN_EMAIL)) {
    toast('Access denied.', 'error');
    return;
  }
  if (currentPage===page) return;
  currentPage = page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const pageEl = document.getElementById('page-'+page);
  if (pageEl) pageEl.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>{
    const txt = n.textContent.trim().toLowerCase();
    if ((page==='dashboard'&&txt.includes('dashboard'))||(page==='projects'&&txt.includes('projects'))||(page==='logger'&&txt.includes('focus logger'))||(page==='heatmap'&&txt.includes('activity'))||(page==='store'&&txt.includes('unlock'))||(page==='admin'&&txt.includes('admin')))
      n.classList.add('active');
  });
  document.getElementById('page-title').textContent = pageTitles[page]||page;
  closeSidebar();
  if (page==='admin') loadAdminData();
}

/* =============================================
   ACTIONS
   ============================================= */
function openModal() {
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('sub-name').focus(), 100);
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

async function addSubject() {
  const name = document.getElementById('sub-name').value.trim();
  const date = document.getElementById('sub-date').value;
  const pri  = document.getElementById('sub-priority').value;
  const prog = parseInt(document.getElementById('sub-progress').value);
  if (!name) return toast('Please enter a project name.','error');
  if (!date) return toast('Please select a deadline.','error');

  // All users have unlimited projects
  closeModal();
  await doInsertProject({ name, date, pri, prog });
}

async function doInsertProject({ name, date, pri, prog }) {
  setSyncing(true);
  const { error } = await sb.from('subjects').insert({
    user_id:currentUser.id, subject_name:name, exam_date:date, priority:pri, progress:prog,
  });
  setSyncing(false);
  if (error) { toast('Error: '+error.message,'error'); return; }
  toast('Project added!','success');
  document.getElementById('sub-name').value='';
  document.getElementById('sub-date').value='';
  document.getElementById('sub-progress').value=0;
  document.getElementById('prog-label').textContent='0%';
  await loadAll();
}

async function updateProgress(id, val, slider) {
  setSyncing(true);
  const { error } = await sb.from('subjects').update({ progress:parseInt(val) }).eq('id',id).eq('user_id',currentUser.id);
  setSyncing(false);
  if (error) toast('Update failed: '+error.message,'error');
  else { const s=allProjects.find(x=>x.id===id); if(s) s.progress=parseInt(val); renderStats(); }
}

async function deleteProject(id) {
  if (!confirm('Delete this project and all its sessions? This cannot be undone.')) return;
  setSyncing(true);
  await sb.from('study_logs').delete().eq('subject_id',id).eq('user_id',currentUser.id);
  const { error } = await sb.from('subjects').delete().eq('id',id).eq('user_id',currentUser.id);
  setSyncing(false);
  if (error) { toast('Error: '+error.message,'error'); return; }
  toast('Project removed.','info');
  await loadAll();
}

async function addLog() {
  const projId = document.getElementById('log-project').value;
  const date   = document.getElementById('log-date').value;
  const dur    = parseInt(document.getElementById('log-duration').value);
  if (!projId) return toast('Please select a project.','error');
  if (!date)   return toast('Please select a date.','error');
  if (!dur||dur<1) return toast('Please enter a valid duration.','error');

  // Calculate credit cost
  const creditCost = calcCreditsForSession(dur);

  // Check credits
  if (!isUnlimited() && userAccount.credits < creditCost) {
    showCreditsEmptyDialog();
    return;
  }

  setSyncing(true);
  const { error } = await sb.from('study_logs').insert({
    user_id:currentUser.id, subject_id:projId, study_date:date, duration_minutes:dur,
  });
  setSyncing(false);
  if (error) { toast('Error: '+error.message,'error'); return; }

  // Deduct credits
  const success = await consumeCredits(creditCost);
  if (!success) { toast('Session logged but credits could not be deducted.','error'); }
  else { toast(`Session logged! −${creditCost} credits used.`,'success'); }

  document.getElementById('log-duration').value='';
  document.getElementById('credit-cost-preview').style.display='none';
  await loadAll();
}

function openLogForProject(projId) {
  navTo('logger');
  setTimeout(()=>{
    document.getElementById('log-project').value = projId;
    document.getElementById('log-duration').focus();
    updateCreditPreview();
  }, 150);
}

/* =============================================
   ADMIN PANEL
   ============================================= */
async function loadAdminData() {
  if (userAccount.role!=='admin') return;
  const tbody = document.getElementById('admin-users-body');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:1.5rem;color:var(--text-muted)"><span class="loader"></span></td></tr>';

  const { data:accounts } = await sb.from('user_accounts').select('*').order('created_at',{ascending:false});
  const { data:exceptions } = await sb.from('exception_users').select('*');

  const excList = document.getElementById('admin-exceptions-list');
  if (excList && exceptions) {
    if (!exceptions.length) {
      excList.innerHTML = '<p style="font-size:0.8rem;color:var(--text-muted)">No exception users yet.</p>';
    } else {
      excList.innerHTML = exceptions.map(e=>`
        <div style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border)">
          <span style="font-size:0.875rem">${escHtml(e.email)}</span>
          <button class="btn btn-danger btn-sm" onclick="adminRemoveException('${escHtml(e.email)}')">Remove</button>
        </div>`).join('');
    }
  }

  if (!accounts) { tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--danger)">Error loading users</td></tr>'; return; }

  tbody.innerHTML = accounts.map(acc => {
    const weeklyCredits = acc.weekly_credits ?? 0;
    const isExc = (exceptions||[]).some(e=>e.email===acc.email);
    const isAdm = acc.email===ADMIN_EMAIL;
    const roleLabel = isAdm?'👑 Admin':isExc?'⭐ Exception':'👤 Member';
    const lastReset = acc.weekly_reset_at ? new Date(acc.weekly_reset_at).toLocaleDateString() : '—';
    return `<tr>
      <td style="font-size:0.8rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(acc.email||'')}">${escHtml(acc.email||'')}</td>
      <td style="font-size:0.75rem;color:var(--text-muted)">${escHtml(acc.plan||'free')}</td>
      <td style="font-weight:600">${isAdm||isExc?'∞':weeklyCredits}</td>
      <td style="font-size:0.75rem;color:var(--text-muted)">${lastReset}</td>
      <td>${roleLabel}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="adminAddCredits('${acc.user_id}','${escHtml(acc.email||'')}')">+ Credits</button></td>
    </tr>`;
  }).join('');
}

async function adminSetPlan(userId, plan) {
  if (userAccount.role!=='admin') return;
  const { error } = await sb.from('user_accounts').update({ plan }).eq('user_id',userId);
  if (error) toast('Error: '+error.message,'error');
  else { toast('Plan field updated.','success'); await loadAdminData(); }
}

async function adminAddCredits(userId, email) {
  if (userAccount.role !== 'admin' || currentUser?.email !== ADMIN_EMAIL) return;
  const amount = parseInt(prompt(`Add weekly credits for ${email}:`,'50'));
  if (!amount||isNaN(amount)||amount<1) return;
  const { data } = await sb.from('user_accounts').select('weekly_credits').eq('user_id',userId).single();
  const newWc = (data?.weekly_credits||0)+amount;
  const { error } = await sb.from('user_accounts').update({ weekly_credits: newWc }).eq('user_id',userId);
  if (error) toast('Error: '+error.message,'error');
  else { toast(`Added ${amount} credits to ${email}!`,'success'); await loadAdminData(); }
}

async function adminAddException() {
  if (userAccount.role !== 'admin' || currentUser?.email !== ADMIN_EMAIL) return;
  const email = document.getElementById('admin-add-exception-email').value.trim().toLowerCase();
  if (!email||!email.includes('@')) { toast('Enter a valid email.','error'); return; }
  const { error } = await sb.from('exception_users').upsert({ email },{onConflict:'email'});
  if (error) { toast('Error: '+error.message,'error'); return; }
  EXCEPTION_EMAILS.push(email);
  document.getElementById('admin-add-exception-email').value='';
  toast(`${email} added as exception user!`,'success');
  await loadAdminData();
}

async function adminRemoveException(email) {
  if (userAccount.role !== 'admin' || currentUser?.email !== ADMIN_EMAIL) return;
  if (!confirm(`Remove exception for ${email}?`)) return;
  const { error } = await sb.from('exception_users').delete().eq('email',email);
  if (error) { toast('Error: '+error.message,'error'); return; }
  const idx = EXCEPTION_EMAILS.indexOf(email); if(idx>-1) EXCEPTION_EMAILS.splice(idx,1);
  toast(`Removed exception for ${email}.`,'info');
  await loadAdminData();
}

/* =============================================
   SIDEBAR TOGGLE
   ============================================= */
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}

/* =============================================
   PROFILE PANEL
   ============================================= */
function openProfile() {
  document.getElementById('profile-new-email').value='';
  document.getElementById('profile-new-pass').value='';
  document.getElementById('profile-confirm-pass').value='';
  document.getElementById('profile-class').value = profileData.userClass||'';
  syncPanelAvatar();
  document.getElementById('profile-overlay').classList.add('open');
  document.getElementById('profile-panel').classList.add('open');
}
function closeProfile() {
  document.getElementById('profile-overlay').classList.remove('open');
  document.getElementById('profile-panel').classList.remove('open');
}
function syncPanelAvatar() {
  const circle = document.getElementById('profile-avatar-circle');
  const img    = document.getElementById('profile-avatar-img');
  if (profileData.photoDataUrl) { img.src=profileData.photoDataUrl; img.style.display='block'; circle.style.display='none'; }
  else { img.style.display='none'; circle.style.display='flex'; circle.textContent=currentUser?.email?.[0]?.toUpperCase()||'?'; }
}
function handleAvatarChange(e) {
  const file = e.target.files[0]; if(!file) return;
  if (file.size>3*1024*1024) { toast('Image must be under 3MB.','error'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => { profileData.photoDataUrl=ev.target.result; syncPanelAvatar(); toast('Profile photo updated!','success'); };
  reader.readAsDataURL(file); e.target.value='';
}
async function changeEmail() {
  const newEmail = document.getElementById('profile-new-email').value.trim();
  if (!newEmail) { toast('Please enter a new email.','error'); return; }
  if (newEmail===currentUser.email) { toast('That is already your email.','error'); return; }
  setLoading('btn-change-email',true);
  const { error } = await sb.auth.updateUser({ email:newEmail });
  setLoading('btn-change-email',false);
  if (error) { toast('Error: '+error.message,'error'); return; }
  toast('Confirmation sent to new email.','success');
  document.getElementById('profile-new-email').value='';
}
async function changePassword() {
  const pass = document.getElementById('profile-new-pass').value;
  const conf = document.getElementById('profile-confirm-pass').value;
  if (!pass)              { toast('Please enter a new password.','error'); return; }
  if (pass.length<6)      { toast('Password must be at least 6 characters.','error'); return; }
  if (pass!==conf)        { toast('Passwords do not match.','error'); return; }
  setLoading('btn-change-pass',true);
  const { error } = await sb.auth.updateUser({ password:pass });
  setLoading('btn-change-pass',false);
  if (error) { toast('Error: '+error.message,'error'); return; }
  toast('Password updated!','success');
  document.getElementById('profile-new-pass').value='';
  document.getElementById('profile-confirm-pass').value='';
}
function saveClass() {
  const cls = document.getElementById('profile-class').value.trim();
  profileData.userClass = cls;
  toast('Role saved!','success');
}
function togglePassVis(inputId, btn) {
  const input = document.getElementById(inputId);
  const isHidden = input.type==='password';
  input.type = isHidden?'text':'password';
  btn.innerHTML = isHidden
    ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`
    : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;
}
async function confirmResetProgress() {
  if (!allProjects.length) { toast('No projects to reset.','info'); return; }
  if (!confirm('Reset skill progress on ALL projects to 0%? This cannot be undone.')) return;
  setLoading('btn-reset-progress',true);
  const ids = allProjects.map(s=>s.id);
  const { error } = await sb.from('subjects').update({ progress:0 }).in('id',ids).eq('user_id',currentUser.id);
  setLoading('btn-reset-progress',false);
  if (error) { toast('Error: '+error.message,'error'); return; }
  toast('All progress reset to 0%.','info');
  await loadAll();
  closeProfile();
}

/* =============================================
   INIT
   ============================================= */
(async () => {
  const { data } = await sb.auth.getSession();
  if (!data.session) showAuth();
})();
</script>
</body>
</html>
